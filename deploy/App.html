<!DOCTYPE html>
<html>
<head>
    <title>EstimateActualTrend</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._doLayout()},_doLayout:function(){this._storyPointPicker=this.add({xtype:"rallynumberfield",fieldLabel:"Story Point Filter",maxValue:21,minValue:1,value:3,listeners:{change:this._onStoryPointPickerChanged,ready:this._onStoryPointPickerLoad,scope:this}}),this._loadStories(3)},_onStoryPointPickerChanged:function(){console.log("changed story points: ",this._storyPointPicker.getValue()),this._loadStories(this._storyPointPicker.getValue())},_onStoryPointPickerLoad:function(){this._loadStories(this._storyPointPicker.getValue())},_loadStories:function(storyPoints){console.log("Loading stories"),Ext.create("Rally.data.WsapiDataStore",{model:"UserStory",filters:[{property:"ScheduleState",operator:">=",value:"Completed"},{property:"Iteration.StartDate",operator:">=",value:"LastYear"},{property:"PlanEstimate",operator:"=",value:storyPoints}],sorters:[{property:"InProgressDate",direction:"ASC"}],autoLoad:!0,listeners:{load:function(store,records,success){records&&(console.log("Loaded Store with %i records",records.length),this._aggregateArray=[],this._coordinateArray=[],this._calculateData(records,this._aggregateArray,this._coordinateArray),this._loadChart(this._coordinateArray,this._aggregateArray))},scope:this},fetch:["Name","FormattedID","PlanEstimate","TaskActualTotal","ScheduleState","Iteration"]})},_calculateData:function(records,aggArray,coordArray){var maxHours=-1,minHours=-1,totalHours=0,avgHours=0,standardDeviation=0,foundMatch=!1;console.log("calculating data");var iterationNames=[],nextIndex=0;Ext.Array.each(records,function(story){var name=story.data.Name,formattedID=story.data.FormattedID,planEstimate=story.data.PlanEstimate,taskActualTotal=story.data.TaskActualTotal,scheduleState=story.data.ScheduleState,currentIndex=0,foundMatch=!1,iterationName=story.get("Iteration")._refObjectName;Ext.Array.each(iterationNames,function(element){iterationName==element[1]&&(currentIndex=element[0],foundMatch=!0,console.log("Current Index: ",currentIndex))}),foundMatch||(currentIndex=nextIndex,iterationNames.push([currentIndex,iterationName]),nextIndex++),totalHours+=taskActualTotal,(-1===maxHours||maxHours>taskActualTotal)&&(maxHours=taskActualTotal),taskActualTotal>minHours&&(minHours=taskActualTotal),console.log("Name: ",name),console.log("ID: ",formattedID),console.log("PlanEstimate: ",planEstimate),console.log("TaskActualTotal: ",taskActualTotal),console.log("Schedule State: ",scheduleState),console.log("IterationName: ",iterationName),coordArray.push([currentIndex,taskActualTotal])}),avgHours=totalHours/records.length,aggArray.push(maxHours,minHours,avgHours),console.log("IterationNames",iterationNames),console.log("CoordArray: ",coordArray)},_loadChart:function(coordArray,aggrArray){var chartConfig={chart:{type:"scatter",zoomType:"xy"},title:{text:"Accuracy Over Time"},subtitle:{text:"Todd & Summer"},xAxis:{title:{enabled:!0,text:"Iteration"},startOnTick:!0,endOnTick:!0,showLastLabel:!0,type:"category"},yAxis:{title:{text:"Hours"}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-50,y:35,floating:!0,backgroundColor:"#FFFFFF",borderWidth:1},plotOptions:{scatter:{marker:{radius:5,states:{hover:{enabled:!0,lineColor:"rgb(100,100,100)"}}},states:{hover:{marker:{enabled:!1}}},tooltip:{headerFormat:"<b>{series.name}</b><br>",pointFormat:"{point.x} Iteration, {point.y} Hours"}}}};chart={xtype:"rallychart",height:350,chartConfig:chartConfig,chartData:{series:[{name:"3-points Stories",color:"rgba(223, 83, 83, .5)",marker:{symbol:"circle"},data:coordArray},{name:"5-points",color:"rgba(119, 152, 191, .5)",marker:{symbol:"circle"},data:[{x:0,y:5},{x:0,y:17},{x:0,y:14},{x:0,y:2},{x:0,y:12},{x:0,y:9},{x:0,y:0},{x:1,y:3},{x:1,y:10},{x:1,y:9},{x:1,y:19},{x:1,y:8},{x:1,y:0},{x:2,y:4},{x:2,y:9},{x:2,y:21},{x:3,y:5},{x:3,y:6},{x:3,y:9},{x:3,y:10},{x:4,y:19},{x:4,y:2},{x:5,y:6}]},{name:"Mean",color:"rgba(9, 110, 11, .5)",marker:{symbol:"square"},data:[{x:0,y:aggrArray[2]}]},{name:"Max",color:"rgba(0, 0, 0, .5)",marker:{symbol:"triangle"},data:[{x:0,y:aggrArray[0]}]},{name:"Min",color:"rgba(0, 0, 0, .5)",marker:{symbol:"triangle-down"},data:[{x:0,y:aggrArray[1]}]},{categories:["iteration 1 <br>StDev:6.5","iteration 2<br>StDev:4.9","iteration 3<br>StDev:4.3","iteration 4<br>StDev:3.8","iteration 5<br>StDev: 3.2","iteration 6<br>StDev: 2.2","iteration 7 <br>StDev:6.5","iteration 8 <br>StDev:6.5","iteration 9 <br>StDev:6.5","iteration 10 <br>StDev:5.5","iteration 11 <br>StDev:3.5","iteration 12 <br>StDev:2.5"]}]}},this.add(chart)},_createGrid:function(myStore){console.log("Load up a populated grid!",myStore),this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",title:"Story Grid",height:500,store:myStore,columnCfgs:[{text:"Story ID",dataIndex:"FormattedID",flex:1,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},{text:"PlanEstimate",dataIndex:"PlanEstimate",flex:1},{text:"TaskActualTotal",dataIndex:"TaskActualTotal",flex:1},{text:"Schedule State",dataIndex:"ScheduleState",flex:2},{text:"Iteration",dataIndex:"Iteration.Name",flex:1,renderer:function(value,metaData,record){return record.get("Iteration")._refObjectName}}]}),this.add(this._myGrid)},_updateGrid:function(myStore){void 0===this._myGrid?this._createGrid(myStore):this._myGrid.reconfigure(myStore)}});

            Rally.launchApp('CustomApp', {
                name:"EstimateActualTrend",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
